<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆIDç™»å½•æµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #1a1a2e; color: white; padding: 20px; }
        .container { max-width: 500px; margin: 50px auto; }
        h1 { color: #4cc9f0; margin-bottom: 30px; text-align: center; }
        .card { background: #16213e; padding: 25px; border-radius: 10px; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #a5b4cb; }
        input { width: 100%; padding: 12px; background: #0f3460; border: 1px solid #2d4059; border-radius: 5px; color: white; }
        button { width: 100%; padding: 14px; background: #4361ee; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        button:hover { background: #3a56d4; }
        button:disabled { background: #2d4059; cursor: not-allowed; }
        .result { margin-top: 20px; padding: 15px; border-radius: 5px; display: none; }
        .success { background: rgba(76, 201, 240, 0.1); border-left: 4px solid #4cc9f0; display: block; }
        .error { background: rgba(240, 84, 84, 0.1); border-left: 4px solid #f05454; display: block; }
        .debug { font-family: monospace; font-size: 12px; background: #000; padding: 10px; border-radius: 5px; margin-top: 20px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ¸¸æˆIDç™»å½•æµ‹è¯•</h1>
        
        <div class="card">
            <div class="input-group">
                <label>åç«¯åœ°å€</label>
                <input type="text" id="backendUrl" placeholder="https://your-backend.onrender.com" value="">
                <small style="color: #a5b4cb; display: block; margin-top: 5px;">è¾“å…¥ä½ çš„Renderåç«¯åœ°å€</small>
            </div>
            
            <div class="input-group">
                <label>é‚®ç®±</label>
                <input type="email" id="email" placeholder="liewhy1699@gmail.com" value="liewhy1699@gmail.com">
            </div>
            
            <div class="input-group">
                <label>å¯†ç </label>
                <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            
            <button id="loginBtn" onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
            <button id="healthBtn" onclick="checkHealth()" style="margin-top: 10px; background: #7209b7;">æ£€æŸ¥åç«¯çŠ¶æ€</button>
            
            <div id="result" class="result"></div>
            
            <div id="debug" class="debug"></div>
        </div>
        
        <div style="margin-top: 30px; color: #a5b4cb; font-size: 14px; text-align: center;">
            <p>ğŸ”§ è°ƒè¯•æ­¥éª¤ï¼š</p>
            <p>1. è¾“å…¥åç«¯åœ°å€ â†’ 2. ç‚¹å‡»"æ£€æŸ¥åç«¯çŠ¶æ€" â†’ 3. è¾“å…¥é‚®ç®±å¯†ç  â†’ 4. ç‚¹å‡»"æµ‹è¯•ç™»å½•"</p>
            <p>æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·æŸ¥çœ‹ç½‘ç»œè¯·æ±‚</p>
        </div>
    </div>

    <script>
        // è°ƒè¯•å‡½æ•°ï¼šæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
        function showDebug(msg) {
            const debugDiv = document.getElementById('debug');
            debugDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${msg}</div>`;
            debugDiv.style.display = 'block';
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(type, message) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>${type === 'success' ? 'âœ…' : 'âŒ'} ${type === 'success' ? 'æˆåŠŸ' : 'é”™è¯¯'}:</strong> ${message}`;
        }
        
        // æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
        async function checkHealth() {
            const backendUrl = document.getElementById('backendUrl').value.trim();
            if (!backendUrl) {
                showResult('error', 'è¯·è¾“å…¥åç«¯åœ°å€');
                return;
            }
            
            showDebug(`æ£€æŸ¥åç«¯å¥åº·: ${backendUrl}/api/health`);
            
            try {
                const response = await fetch(`${backendUrl}/api/health`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                const data = await response.json();
                showDebug(`å“åº”çŠ¶æ€: ${response.status}`);
                showDebug(`å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`);
                
                if (response.ok) {
                    showResult('success', `åç«¯è¿è¡Œæ­£å¸¸ï¼æœåŠ¡: ${data.service || 'æœªçŸ¥'}`);
                } else {
                    showResult('error', `åç«¯å¼‚å¸¸: ${response.status} ${data.message || ''}`);
                }
            } catch (error) {
                showDebug(`è¯·æ±‚å¤±è´¥: ${error.message}`);
                showResult('error', `æ— æ³•è¿æ¥åˆ°åç«¯: ${error.message}`);
            }
        }
        
        // æµ‹è¯•ç™»å½•
        async function testLogin() {
            const backendUrl = document.getElementById('backendUrl').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!backendUrl || !email || !password) {
                showResult('error', 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'ç™»å½•ä¸­...';
            
            showDebug(`å¼€å§‹ç™»å½•: ${email} â†’ ${backendUrl}/api/login`);
            
            try {
                const response = await fetch(`${backendUrl}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                showDebug(`ç™»å½•å“åº”çŠ¶æ€: ${response.status}`);
                
                const data = await response.json();
                showDebug(`ç™»å½•å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`);
                
                if (response.ok && data.success) {
                    showResult('success', `ç™»å½•æˆåŠŸï¼ç”¨æˆ·: ${data.user.email}<br>Token: ${data.token.idToken.substring(0, 30)}...`);
                    
                    // ä¿å­˜Tokenä¾›åç»­ä½¿ç”¨
                    localStorage.setItem('token', data.token.idToken);
                    localStorage.setItem('userEmail', data.user.email);
                    
                    // æµ‹è¯•ä¿®æ”¹IDåŠŸèƒ½
                    setTimeout(() => testChangeId(backendUrl, data.token.idToken), 1000);
                } else {
                    showResult('error', `ç™»å½•å¤±è´¥: ${data.message || data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                showDebug(`ç™»å½•è¯·æ±‚å¼‚å¸¸: ${error.message}`);
                showResult('error', `è¯·æ±‚å¤±è´¥: ${error.message}<br>è¯·æ£€æŸ¥ï¼š1. åç«¯åœ°å€æ­£ç¡® 2. CORSé…ç½® 3. ç½‘ç»œè¿æ¥`);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'æµ‹è¯•ç™»å½•';
            }
        }
        
        // æµ‹è¯•ä¿®æ”¹IDåŠŸèƒ½
        async function testChangeId(backendUrl, token) {
            showDebug(`æµ‹è¯•ä¿®æ”¹IDåŠŸèƒ½...`);
            
            try {
                const response = await fetch(`${backendUrl}/api/change-id`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        newLocalId: 'TEST' + Math.floor(Math.random() * 1000),
                        idToken: token
                    })
                });
                
                const data = await response.json();
                showDebug(`ä¿®æ”¹IDå“åº”: ${JSON.stringify(data, null, 2)}`);
                
                if (data.success) {
                    showResult('success', `âœ… å®Œæ•´æµç¨‹æµ‹è¯•é€šè¿‡ï¼<br>ç™»å½•æˆåŠŸ â†’ ä¿®æ”¹IDæˆåŠŸ<br>æ–°ID: ${data.gameResponse?.newLocalId || 'æœªçŸ¥'}`);
                } else {
                    showResult('error', `ç™»å½•æˆåŠŸä½†ä¿®æ”¹IDå¤±è´¥: ${data.message}`);
                }
            } catch (error) {
                showDebug(`ä¿®æ”¹IDå¤±è´¥: ${error.message}`);
                showResult('error', `ç™»å½•æˆåŠŸï¼Œä½†ä¿®æ”¹IDå¤±è´¥: ${error.message}`);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„åç«¯åœ°å€
        window.onload = function() {
            const savedUrl = localStorage.getItem('backendUrl');
            if (savedUrl) {
                document.getElementById('backendUrl').value = savedUrl;
            }
        };
    </script>
</body>
</html>
